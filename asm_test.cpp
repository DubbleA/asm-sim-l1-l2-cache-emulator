#include <iostream>
#include <fstream>
#include <string>
#include <sstream>
#include <vector>
#include "asm.cpp"

struct TestCase {
    std::string filename;
    std::vector<std::string> expected;
};
void assembleInstructions(const std::string& filename, std::vector<std::string>& output);

void testAssembler(){
    std::vector<TestCase> tests = {
        {"asmfiles/fib_iter.s", {
            "ram[0] = 16'b0010000010001000;",
            "ram[1] = 16'b0010000100000000;",
            "ram[2] = 16'b0010000110000001;",
            "ram[3] = 16'b1100010000000101;",
            "ram[4] = 16'b0010010011111111;",
            "ram[5] = 16'b0000100111000000;",
            "ram[6] = 16'b0000000110100000;",
            "ram[7] = 16'b0000001000110000;",
            "ram[8] = 16'b0100000000000011;",
            "ram[9] = 16'b0000000110010000;",
            "ram[10] = 16'b0100000000001010;"
        }},
        {"asmfiles/array-sum.s", {
            "ram[0] = 16'b0010000010000000;",
            "ram[1] = 16'b0010000110000000;",
            "ram[2] = 16'b1000010100001000;",
            "ram[3] = 16'b0000110100110000;",
            "ram[4] = 16'b0010010010000001;",
            "ram[5] = 16'b1100100000000001;",
            "ram[6] = 16'b0100000000000010;",
            "ram[7] = 16'b0100000000000111;",
            "ram[8] = 16'b0000000110110010;",
            "ram[9] = 16'b0000100100100110;",
            "ram[10] = 16'b0111110010110100;",
            "ram[11] = 16'b0000000000000011;",
            "ram[12] = 16'b0000000001010101;",
            "ram[13] = 16'b0000000000000000;"
        }},
        {"asmfiles/loop1.s", {
            "ram[0] = 16'b0010000010001010;",
            "ram[1] = 16'b1100010000000010;",
            "ram[2] = 16'b0010010011111111;",
            "ram[3] = 16'b0100000000000001;",
            "ram[4] = 16'b0100000000000100;"
        }},
        {"asmfiles/loop2.s", {
            "ram[0] = 16'b0010000010001010;",
            "ram[1] = 16'b0100000000000011;",
            "ram[2] = 16'b0100000000000010;",
            "ram[3] = 16'b1100010001111110;",
            "ram[4] = 16'b0010010011111111;",
            "ram[5] = 16'b0100000000000011;"
        }},
        {"asmfiles/loop3.s", {
            "ram[0] = 16'b0010000010111111;",
            "ram[1] = 16'b0010001100000001;",
            "ram[2] = 16'b0100000000000100;",
            "ram[3] = 16'b0100000000000011;",
            "ram[4] = 16'b1110011010001010;",
            "ram[5] = 16'b1101011101111101;",
            "ram[6] = 16'b0010010011111101;",
            "ram[7] = 16'b0100000000000100;"
        }},
        {"asmfiles/math.s", {
            "ram[0] = 16'b0010000010000101;",
            "ram[1] = 16'b0010010101111110;",
            "ram[2] = 16'b0000010100110000;",
            "ram[3] = 16'b0010001000110111;",
            "ram[4] = 16'b0001000011010001;",
            "ram[5] = 16'b0001011001000001;",
            "ram[6] = 16'b0000101011100011;",
            "ram[7] = 16'b0000101011110010;",
            "ram[8] = 16'b0100000000001000;"
        }},
        {"asmfiles/subroutine1.s", {
            "ram[0] = 16'b0010000010000001;",
            "ram[1] = 16'b0110000000000100;",
            "ram[2] = 16'b0010000100000010;",
            "ram[3] = 16'b0100000000000011;",
            "ram[4] = 16'b0010000110000011;",
            "ram[5] = 16'b0001110000001000;"
        }},
        {"asmfiles/subroutine2.s", {
            "ram[0] = 16'b0010000010000011;",
            "ram[1] = 16'b0110000000000111;",
            "ram[2] = 16'b0000000010100000;",
            "ram[3] = 16'b0010000010001001;",
            "ram[4] = 16'b0110000000000111;",
            "ram[5] = 16'b0000000010110000;",
            "ram[6] = 16'b0100000000000110;",
            "ram[7] = 16'b0000010010010000;",
            "ram[8] = 16'b0000010010010000;",
            "ram[9] = 16'b0001110000001000;"
        }},
        {"asmfiles/vars1.s", {
            "ram[0] = 16'b1000000010001001;",
            "ram[1] = 16'b1000000100001010;",
            "ram[2] = 16'b0000010100110010;",
            "ram[3] = 16'b0000010101000011;",
            "ram[4] = 16'b1010000110001011;",
            "ram[5] = 16'b1000001110001011;",
            "ram[6] = 16'b0010001010001011;",
            "ram[7] = 16'b0011011100001100;",
            "ram[8] = 16'b0100000000001000;",
            "ram[9] = 16'b0000000000011110;",
            "ram[10] = 16'b0000000000000101;",
            "ram[11] = 16'b0000000000000000;"
        }},
            {"simfiles/array-sum.s", {
            "ram[0] = 16'b0010000010000000;",
            "ram[1] = 16'b0010000110000000;",
            "ram[2] = 16'b1000010100001000;",
            "ram[3] = 16'b0000110100110000;",
            "ram[4] = 16'b0010010010000001;",
            "ram[5] = 16'b1100100000000001;",
            "ram[6] = 16'b0100000000000010;",
            "ram[7] = 16'b0100000000000111;",
            "ram[8] = 16'b0000000110110010;",
            "ram[9] = 16'b0000100100100110;",
            "ram[10] = 16'b0111110010110100;",
            "ram[11] = 16'b0000000000000011;",
            "ram[12] = 16'b0000000001010101;",
            "ram[13] = 16'b0001000011010011;",
            "ram[14] = 16'b0000110110010010;",
            "ram[15] = 16'b0001001101010000;",
            "ram[16] = 16'b0000000101111001;",
            "ram[17] = 16'b0001001000010111;",
            "ram[18] = 16'b0000001110101110;",
            "ram[19] = 16'b0000100101100000;",
            "ram[20] = 16'b0000000000010011;",
            "ram[21] = 16'b0000011100011110;",
            "ram[22] = 16'b0000001010010100;",
            "ram[23] = 16'b0000010110110101;",
            "ram[24] = 16'b0000100010001101;",
            "ram[25] = 16'b0000110000101110;",
            "ram[26] = 16'b0000100110111111;",
            "ram[27] = 16'b0000100001010000;",
            "ram[28] = 16'b0000010100111010;",
            "ram[29] = 16'b0000101110011101;",
            "ram[30] = 16'b0000001101111011;",
            "ram[31] = 16'b0000011010101000;",
            "ram[32] = 16'b0000101101001110;",
            "ram[33] = 16'b0000111100101111;",
            "ram[34] = 16'b0000000111100110;",
            "ram[35] = 16'b0000101111011000;",
            "ram[36] = 16'b0001001100111101;",
            "ram[37] = 16'b0000001101011101;",
            "ram[38] = 16'b0000111101011000;",
            "ram[39] = 16'b0000101111100100;",
            "ram[40] = 16'b0000001100111010;",
            "ram[41] = 16'b0000110010110111;",
            "ram[42] = 16'b0001000111011110;",
            "ram[43] = 16'b0000111000001001;",
            "ram[44] = 16'b0000010010010111;",
            "ram[45] = 16'b0000110010111010;",
            "ram[46] = 16'b0000001110110000;",
            "ram[47] = 16'b0000000100100101;",
            "ram[48] = 16'b0000011010011010;",
            "ram[49] = 16'b0000100100001010;",
            "ram[50] = 16'b0000011011010100;",
            "ram[51] = 16'b0001001100010010;",
            "ram[52] = 16'b0000000001101110;",
            "ram[53] = 16'b0000100000110100;",
            "ram[54] = 16'b0000000011101010;",
            "ram[55] = 16'b0000110011011000;",
            "ram[56] = 16'b0000101010110010;",
            "ram[57] = 16'b0000010010010110;",
            "ram[58] = 16'b0000010010011010;",
            "ram[59] = 16'b0000010000000101;",
            "ram[60] = 16'b0000100100001010;",
            "ram[61] = 16'b0000010110101000;",
            "ram[62] = 16'b0000000000000000;"
        }},
            {"simfiles/assoc2.s", {
            "ram[0] = 16'b0010000010100000;",
            "ram[1] = 16'b0000010010010000;",
            "ram[2] = 16'b0000010010100000;",
            "ram[3] = 16'b0000100100100000;",
            "ram[4] = 16'b0000100100100000;",
            "ram[5] = 16'b0000100100100000;",
            "ram[6] = 16'b1000101010000000;",
            "ram[7] = 16'b0000100010110000;",
            "ram[8] = 16'b1000111100000000;",
            "ram[9] = 16'b1000101010000000;",
            "ram[10] = 16'b0000100010110000;",
            "ram[11] = 16'b1000111100000000;",
            "ram[12] = 16'b1000101010000000;",
            "ram[13] = 16'b0000100010110000;",
            "ram[14] = 16'b1000111100000000;",
            "ram[15] = 16'b1000101110110010;",
            "ram[16] = 16'b0000100010110000;",
            "ram[17] = 16'b1000111100000000;",
            "ram[18] = 16'b1000101010000000;",
            "ram[19] = 16'b0100000000010011;"
        }},

        {"simfiles/assoc2a.s", {
            "ram[0] = 16'b0010000010100000;",
            "ram[1] = 16'b0000010010010000;",
            "ram[2] = 16'b0000010010100000;",
            "ram[3] = 16'b0000100100100000;",
            "ram[4] = 16'b0000100100100000;",
            "ram[5] = 16'b0000100100100000;",
            "ram[6] = 16'b1000101010000000;",
            "ram[7] = 16'b0000100010110000;",
            "ram[8] = 16'b1000111100000000;",
            "ram[9] = 16'b0000110010110000;",
            "ram[10] = 16'b1000111100000000;",
            "ram[11] = 16'b1000101010000000;",
            "ram[12] = 16'b0000100010110000;",
            "ram[13] = 16'b1000111100000000;",
            "ram[14] = 16'b1000101010000000;",
            "ram[15] = 16'b0000100010110000;",
            "ram[16] = 16'b1000111100000000;",
            "ram[17] = 16'b0100000000010001;"
        }},

        {"simfiles/lastInstr.s", {
            "ram[0] = 16'b0010010010000001;",
            "ram[1] = 16'b0010000100000010;",
            "ram[2] = 16'b1100010100000001;",
            "ram[3] = 16'b0101111111111111;",
            "ram[4] = 16'b0100000000000100;"
        }},

        {"simfiles/r5q5.s", {
            "ram[0] = 16'b0000000000010000;",
            "ram[1] = 16'b0000000001000000;",
            "ram[2] = 16'b1000000110001001;",
            "ram[3] = 16'b1110110010010100;",
            "ram[4] = 16'b1100010000000011;",
            "ram[5] = 16'b0001000111000000;",
            "ram[6] = 16'b0010110110000001;",
            "ram[7] = 16'b1100000001111011;",
            "ram[8] = 16'b0100000000001000;",
            "ram[9] = 16'b0000000000010000;"
        }},

        {"simfiles/r6q1.s", {
            "ram[0] = 16'b0010000010000011;",
            "ram[1] = 16'b1000000100000011;",
            "ram[2] = 16'b0100000000000010;",
            "ram[3] = 16'b0000000000101010;"
        }},

        {"simfiles/r6q2.s", {
            "ram[0] = 16'b0010000010000100;",
            "ram[1] = 16'b0010010010000001;",
            "ram[2] = 16'b0000010000001000;",
            "ram[3] = 16'b0100000000000011;",
            "ram[4] = 16'b0010000100000010;",
            "ram[5] = 16'b0010000110000011;",
            "ram[6] = 16'b0100000000000110;"
        }},
        
        {"simfiles/r6q3.s", {
            "ram[0] = 16'b0010000010000111;",
            "ram[1] = 16'b0000010010100000;",
            "ram[2] = 16'b1010000010000101;",
            "ram[3] = 16'b1010010100000101;",
            "ram[4] = 16'b0100000000000100;",
            "ram[5] = 16'b0000001001011000;",
            "ram[6] = 16'b0000001010111100;"
        }},

        {"simfiles/r6q4.s", {
            "ram[0] = 16'b0010000010000000;",
            "ram[1] = 16'b0010001110000000;",
            "ram[2] = 16'b1000010100001010;",
            "ram[3] = 16'b1100100000000101;",
            "ram[4] = 16'b0001110101010100;",
            "ram[5] = 16'b1101010000000001;",
            "ram[6] = 16'b0000000101110000;",
            "ram[7] = 16'b0010010010000001;",
            "ram[8] = 16'b0100000000000010;",
            "ram[9] = 16'b0100000000001001;",
            "ram[10] = 16'b0000000000110101;",
            "ram[11] = 16'b0000000000010110;",
            "ram[12] = 16'b0000000001011110;",
            "ram[13] = 16'b0000000000000010;",
            "ram[14] = 16'b0000000000010011;",
            "ram[15] = 16'b0000000000000000;"
        }},

        {"simfiles/r6q5.s", {
            "ram[0] = 16'b0010000010000000;",
            "ram[1] = 16'b1000000100000000;",
            "ram[2] = 16'b0100000000000010;"
        }},

        {"simfiles/r7q7.s", {
            "ram[0] = 16'b0010000010100000;",
            "ram[1] = 16'b0000010010010000;",
            "ram[2] = 16'b0000010010010000;",
            "ram[3] = 16'b1000000100000110;",
            "ram[4] = 16'b0000100010100000;",
            "ram[5] = 16'b1010000100000110;",
            "ram[6] = 16'b0010000110101010;",
            "ram[7] = 16'b0100000000000111;"
        }},

        {"simfiles/r8q5.s", {
            "ram[0] = 16'b0010000010000001;",
            "ram[1] = 16'b0010000100000010;",
            "ram[2] = 16'b0010000110000011;",
            "ram[3] = 16'b0100000000000011;"
        }},

        {"simfiles/stride4.s", {
            "ram[0] = 16'b0010000010110101;",
            "ram[1] = 16'b1000001110010001;",
            "ram[2] = 16'b1011110010000000;",
            "ram[3] = 16'b1011110010000100;",
            "ram[4] = 16'b1011110010001000;",
            "ram[5] = 16'b1011110010001100;",
            "ram[6] = 16'b1011110010010000;",
            "ram[7] = 16'b0010000100001010;",
            "ram[8] = 16'b1100100000000111;",
            "ram[9] = 16'b0010100101111111;",
            "ram[10] = 16'b1001110010000000;",
            "ram[11] = 16'b1001110010000100;",
            "ram[12] = 16'b1001110010001000;",
            "ram[13] = 16'b1001110010001100;",
            "ram[14] = 16'b1001110010010000;",
            "ram[15] = 16'b0100000000001000;",
            "ram[16] = 16'b0100000000010000;",
            "ram[17] = 16'b0000000001100100;"
        }},

        {"simfiles/test.s", {
            "ram[0] = 16'b0010000010000110;",
            "ram[1] = 16'b1000010100000000;",
            "ram[2] = 16'b1000010110000001;",
            "ram[3] = 16'b0000100111000000;",
            "ram[4] = 16'b1010001000000110;",
            "ram[5] = 16'b0100000000000101;",
            "ram[6] = 16'b0000000000001010;",
            "ram[7] = 16'b0000000000010100;"
        }},

        {"simfiles/write-through.s", {
            "ram[0] = 16'b0010000010101010;",
            "ram[1] = 16'b1000000100110010;",
            "ram[2] = 16'b1010000010110010;",
            "ram[3] = 16'b1000000100110010;",
            "ram[4] = 16'b0100000000000100;"
        }},

        {"simfiles/zero.s", {
            "ram[0] = 16'b0010000010000001;",
            "ram[1] = 16'b0010000100000010;",
            "ram[2] = 16'b0000010100000000;",
            "ram[3] = 16'b0000100010000001;",
            "ram[4] = 16'b0000100010000010;",
            "ram[5] = 16'b0000010100000011;",
            "ram[6] = 16'b0000010100000100;",
            "ram[7] = 16'b0010010000000001;",
            "ram[8] = 16'b1000010000000000;",
            "ram[9] = 16'b1110010000000010;",
            "ram[10] = 16'b0000010100110000;",
            "ram[11] = 16'b0100000000001011;"
        }}
    };

    for (const auto& test : tests) {
        // Prepare arguments for assemblerOutput
        const char* args[] = {"asm", test.filename.c_str()};
        std::vector<std::string> output = assemblerOutput(2, const_cast<char**>(args));
        
        bool testPassed = true;

        if (output.size() != test.expected.size()) {
            testPassed = false;
        } else {
            for (size_t i = 0; i < output.size(); i++) {
                if (output[i].compare(test.expected[i]) != 0) {
                    testPassed = false;
                    break;
                }
            }
        }

        std::cout << "Test " << test.filename << ": " << (testPassed ? "PASS" : "FAIL") << std::endl;
        if (!testPassed) {
            std::cout << "Expected:" << std::endl;
            for (const auto& line : test.expected) {
                std::cout << line << std::endl;
            }
            std::cout << "Got:" << std::endl;
            for (const auto& line : output) {
                std::cout << line << std::endl;
            }
        }
    }
}

int main(){
    testAssembler();
    return 0;
}

//g++ -std=c++20 -Isrc asm_test.cpp -o asm_test && ./asm_test